/*
 * EMService
 * Easemob Rest API
 *
 * The version of the OpenAPI document: 1.0.0
 *
 *
 * NOTE: This class is auto generated by OpenAPI Generator (https://openapi-generator.tech).
 * https://openapi-generator.tech
 * Do not edit the class manually.
 */


package com.easemob.im.api;

import com.easemob.im.ApiException;
import com.easemob.im.api.model.EMCreateToken;
import com.easemob.im.api.model.EMCreateUser;
import com.easemob.im.api.model.EMGetToken;
import org.junit.jupiter.api.Test;

import java.util.ArrayList;
import java.util.List;

import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;
import static org.junit.jupiter.api.Assertions.assertNotNull;

/**
 * API tests for TokenApi
 */
public class TokenApiTest extends AbstractTest {

    private final TokenApi tokenApi = new TokenApi();

    private final UserApi userApi = new UserApi();

    public TokenApiTest() {
    }

    /**
     * 获取管理员 Token
     * <p>
     * 管理员权限 Token 可以用来调用环信 Rest API 接口，获取管理员 Token 文档介绍：https://docs-im-beta.easemob.com/document/server-side/easemob_app_token.html
     *
     * @throws ApiException if the Api call fails
     */
    @Test
    public void getTokenTest() throws ApiException {
        EMCreateToken emCreateAppToken = new EMCreateToken();
        emCreateAppToken.setGrantType("client_credentials");
        emCreateAppToken.setClientId("YXA6a1jQXZnASMeiRB_z6Vo9wA");
        emCreateAppToken.setClientSecret("YXA6LDJ_YHmppwgccxHNEZmyMnjWy1E");
        EMGetToken appToken = assertDoesNotThrow(() -> tokenApi.getToken(emCreateAppToken));
        assertNotNull(appToken.getAccessToken());
    }

    /**
     * 根据用户名和密码获取用户 Token
     * <p>
     * 获取用户 Token 文档介绍：https://docs-im-beta.easemob.com/document/server-side/easemob_user_token.html
     *
     * @throws ApiException if the Api call fails
     */
    @Test
    public void getUserTokenWithUsernameAndPasswordTest() throws ApiException {
        String username = randomUserName();
        String password = "123456";

        List<EMCreateUser> emCreateUserList = new ArrayList<>();
        EMCreateUser createUser = new EMCreateUser();
        createUser.setUsername(username);
        createUser.setPassword(password);

        emCreateUserList.add(createUser);

        assertDoesNotThrow(() -> userApi.createUsers(emCreateUserList));

        EMCreateToken emCreateUserToken = new EMCreateToken();
        emCreateUserToken.setGrantType("password");
        emCreateUserToken.setUsername(username);
        emCreateUserToken.setPassword(password);
        EMGetToken userToken = assertDoesNotThrow(() -> tokenApi.getToken(emCreateUserToken));
        assertNotNull(userToken.getAccessToken());

        assertDoesNotThrow(() -> userApi.deleteUser(username));
    }

    /**
     * 根据用户名获取用户 Token
     * <p>
     * 获取用户 Token 文档介绍：https://docs-im-beta.easemob.com/document/server-side/easemob_user_token.html
     *
     * @throws ApiException if the Api call fails
     */
    @Test
    public void getUserTokenWithUsernameTest() throws ApiException {
        String username = randomUserName();

        EMCreateToken emCreateUserToken = new EMCreateToken();
        emCreateUserToken.setGrantType("inherit");
        emCreateUserToken.setUsername(username);
        emCreateUserToken.setAutoCreateUser(true);
        EMGetToken userToken = assertDoesNotThrow(() -> tokenApi.getToken(emCreateUserToken));
        assertNotNull(userToken.getAccessToken());

        assertDoesNotThrow(() -> userApi.deleteUser(username));
    }

}
